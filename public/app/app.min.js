var CBApp=angular.module("CBApp",["ngRoute","validation.match","ngCookies"]);CBApp.config(["$routeProvider",function(a){a.when("/login",{controller:"UserController",templateUrl:"app/views/login.html",resolve:{userLoggedIn:["$rootScope","APIService",function(a,b){return b.getUserLoggedIn().success(function(b){a.userLoggedIn=b.nickname?b:null})}]}}).when("/register",{controller:"UserController",templateUrl:"app/views/register.html",resolve:{userLoggedIn:["$rootScope","APIService",function(a,b){return b.getUserLoggedIn().success(function(b){a.userLoggedIn=b.nickname?b:null})}]}}).when("/main",{controller:"MainController",templateUrl:"app/views/main.html",resolve:{userLoggedIn:["$rootScope","APIService",function(a,b){return b.getUserLoggedIn().success(function(b){a.userLoggedIn=b.nickname?b:null})}]}}).when("/profile",{controller:"MainController",templateUrl:"app/views/profile.html",resolve:{userLoggedIn:["$rootScope","APIService",function(a,b){return b.getUserLoggedIn().success(function(b){a.userLoggedIn=b.nickname?b:null})}]}}).when("/chat",{controller:"ChatController",templateUrl:"app/views/chat.html",resolve:{userLoggedIn:["$rootScope","APIService",function(a,b){return b.getUserLoggedIn().success(function(b){a.userLoggedIn=b.nickname?b:null})}]}}).when("/about",{templateUrl:"app/views/about.html"}).otherwise({redirectTo:"/login"})}]),CBApp.run(["$rootScope","$location","APIService","$cookies",function(a,b,c,d){var e=d.get("profile");if("undefined"!=typeof e&&null!==e){var f=JSON.parse(e);a.profile=f}a.logOut=function(){c.logout().success(function(){b.path("/login"),a.profile=null}),FB.logout(function(){}),d.remove("profile")}}]),CBApp.controller("ChatController",["$rootScope","$scope","Socket","APIService","$location","userLoggedIn",function(a,b,c,d,e,f){function g(a){var c=$.grep(b.elementsPrinted,function(b){return b.id===a.id});if(0===c.length){b.elementsPrinted.push({id:a.id});var d="/"+a.fbId;FB.api(d,{fields:"picture.type(small)"},function(b){if(!b||b.error)console.log(b.error);else{var c=document.createElement("div");c.className="row",c.id=a.id;var d=document.createElement("p");d.className="text-primary col-xs-9 col-sm-9 col-md-9";var e=document.createElement("strong"),f=document.createTextNode(a.nickname);e.appendChild(f),d.appendChild(e);var g=document.createElement("img");g.src=b.picture.data.url,g.className="img-circle";var h=document.createElement("div");h.className="col-xs-3 col-sm-3 col-md-3",h.appendChild(g),c.appendChild(h),c.appendChild(d),i(c)}})}}function h(a){var c=$.grep(b.elementsPrinted,function(b){return b.id===a.id});if(0===c.length){b.elementsPrinted.push({id:a.id});var d=document.createElement("div");d.className="row",d.id=a.id;var e=document.createElement("div");e.className="col-xs-3 col-sm-3 col-md-3",e.id="stuff-element";var f=document.createElement("p");f.className="text-primary col-xs-9 col-sm-9 col-md-9";var g=document.createElement("strong"),h=document.createTextNode(a.nickname);g.appendChild(h),f.appendChild(g),d.appendChild(e),d.appendChild(f),i(d)}}function i(a){var b=document.getElementById("users-fixed");b.appendChild(a)}f.data.nickname||e.path("/login"),b.currentUser=f.data,b.messages=[],b.room=null,b.inRoom=!1,b.users=[],b.elementsPrinted=[],d.getRooms().success(function(a){b.rooms=a}),c.on("send:message",function(a){b.messages.push(a);var c=document.getElementById("chat-messages");c.scrollTop=c.scrollHeight}),c.on("user:join",function(a){b.messages.push({nickname:"User "+a.nickname+" has joined."});var c={nickname:a.nickname,id:a.id},d=b.users.indexOf(c);d<0&&(b.users.push(c),"not_set"!==a.fbId&&null!==a.fbId&&"not_set"!==b.currentUser.fbId&&null!==b.currentUser.fbId?g(a):h(a))}),c.on("user:left",function(a){b.messages.push({nickname:"User "+a.nickname+" has left room."});var c=document.getElementById("users-fixed"),d=document.getElementById(a.id);c.removeChild(d);var e=b.users.find(function(b){return b.id=a.id}),f=b.users.indexOf(e);f<0&&b.users.splice(f,1);var f=b.elementsPrinted.indexOf({id:a.id});f<0&&b.elementsPrinted.splice(f,1)}),c.on("get:users",function(a){a.nickname=b.currentUser.nickname,a.fbId=b.currentUser.fbId,a.id=b.currentUser.id,c.emit("get:user",a)}),c.on("add:user",function(a){var c={nickname:a.nickname,id:a.id},d=b.users.indexOf(c);d<0&&(b.users.push(c),"not_set"!==a.fbId&&null!==a.fbId&&"not_set"!==b.currentUser.fbId&&null!==b.currentUser.fbId?g(a):h(a))}),c.on("refresh:rooms",function(a){d.getRooms().success(function(a){b.rooms=a})}),b.sendMessage=function(){"undefined"!=typeof b.message&&b.message.length>0&&(c.emit("room:sent",{content:b.message,nickname:b.currentUser.nickname,UserId:b.currentUser.id,RoomId:b.room.id}),b.message="")},b.leaveRoom=function(){b.room&&(c.emit("room:leave",{nickname:b.currentUser.nickname,RoomId:b.room.id,id:b.currentUser.id}),b.room=null,b.inRoom=!1,b.users=[],b.messages=[],b.errorMessage=null,a.profile.RoomId=null)},b.createRoom=function(){var e={name:b.roomName};if(null===b.room){for(var f=document.getElementById("users-fixed");f.firstChild;)f.removeChild(f.firstChild);b.elementsPrinted=[],d.addRoom(e).success(function(d){b.roomName="",c.emit("room:join",{RoomId:d.id,nickname:b.currentUser.nickname}),c.emit("new:room"),b.room=d,b.inRoom=!0,b.users,b.errorMessage=null,a.profile.RoomId=d.id})}else b.errorMessage="You can not join new room until you have left from current one."},b.joinRoom=function(e){if(null===b.room){for(var f=document.getElementById("users-fixed");f.firstChild;)f.removeChild(f.firstChild);b.elementsPrinted=[],d.getRoom(e).success(function(d){b.room=d,b.inRoom=!0,b.users=[],b.errorMessage=null,a.profile.RoomId=d.id,c.emit("room:join",{RoomId:d.id,nickname:b.currentUser.nickname,fbId:b.currentUser.fbId,id:b.currentUser.id})})}else b.errorMessage="You can not join this room until you have left from current one."},b.$on("$locationChangeStart",function(a,c,d){b.leaveRoom()}),window.onbeforeunload=function(a){b.leaveRoom()}}]),CBApp.controller("MainController",["$rootScope","$scope","$location","userLoggedIn","APIService",function(a,b,c,d,e){d.data.nickname||c.path("/login"),b.currentUser=d.data,FB.api("/me",{fields:"picture.width(9999).height(9999)"},function(a){if(!a||a.error)console.log(a.error);else{var b=document.getElementById("img-container");b&&(b.innerHTML='<img src="'+a.picture.data.url+'" class="img-responsive img-rounded">')}}),b.updatePassword=function(){b.currentUser.password=b.newPass,null!==b.currentUser.nickname&&""!==b.currentUser.nickname&&b.currentUser.nickname.length>2&&e.updatePassword(b.currentUser).success(function(c){b.errorMessage=null,b.confirmPassword="",b.newPass="",b.message="Update successful!",b.currentUser=c,a.profile=c,$cookies.putObject("profile",c)}).error(function(a){b.errorMessage=a.error,b.message=null})}}]),CBApp.controller("UserController",["$rootScope","$scope","APIService","$location","userLoggedIn","$cookies",function(a,b,c,d,e,f){e.data.nickname&&d.path("/main"),b.redirect=function(){d.path("/login")},b.onFBlogin=function(){FB.login(function(b){b.authResponse&&FB.api("/me",{fields:["first_name","last_name","email"]},function(b){var e={firstName:b.first_name,lastName:b.last_name,nickname:b.first_name,fbId:b.id,email:b.email};c.loginFB(e).success(function(b){a.profile=b,a.profile.RoomId=null,f.putObject("profile",a.profile),d.path("/main")})})},{scope:"public_profile,email"})},b.register=function(){"undefined"!=typeof b.newUser&&(b.newUser.firstName.length<2||b.newUser.nickname.length<3||b.newUser.password.length<8?b.regError="User info not valid! Registration denied.":("undefined"!=typeof b.newUser.lastName&&""!==b.newUser.lastName&&null!==b.newUser.lastName||(b.newUser.lastName="not_set"),b.newUser.fbId="not_set",c.register(b.newUser).success(function(a){d.path("/login")}).error(function(a){b.regError=a.error,b.newUser.lastName=""})))},b.login=function(){"undefined"!=typeof b.user&&c.login(b.user).success(function(b){a.profile=b,a.profile.RoomId=null,f.putObject("profile",a.profile),d.path("/main")}).error(function(a){b.errorText=a.error})}}]),CBApp.service("APIService",["$http",function(a){this.addRoom=function(b){return a.post("/rooms",b)},this.getRoom=function(b){var c="/rooms/"+b;return console.log("Request url: "+c),a.get(c)},this.getRooms=function(){return a.get("/rooms")},this.register=function(b){return a.post("/users",b)},this.login=function(b){return a.post("/users/authenticate",b)},this.getUserLoggedIn=function(){return a.get("/users/current-auth")},this.logout=function(){return a.get("/users/logout")},this.updatePassword=function(b){return a.put("/users/update",b)},this.loginFB=function(b){return a.post("/users/fb_authenticate",b)}}]),CBApp.factory("Socket",["$rootScope",function(a){var b=io.connect();return{on:function(c,d){b.on(c,function(){var c=arguments;a.$apply(function(){d.apply(b,c)})})},emit:function(c,d,e){b.emit(c,d,function(){var c=arguments;a.$apply(function(){e&&e.apply(b,c)})})}}}]);