var CBApp=angular.module("CBApp",["ngRoute","validation.match","ngCookies"]);CBApp.config(["$routeProvider",function(a){a.when("/login",{controller:"UserController",templateUrl:"app/views/login.html",resolve:{userLoggedIn:["$rootScope","APIService",function(a,b){return b.getUserLoggedIn().success(function(b){a.userLoggedIn=b.nickname?b:null})}]}}).when("/register",{controller:"UserController",templateUrl:"app/views/register.html",resolve:{userLoggedIn:["$rootScope","APIService",function(a,b){return b.getUserLoggedIn().success(function(b){a.userLoggedIn=b.nickname?b:null})}]}}).when("/main",{controller:"MainController",templateUrl:"app/views/main.html",resolve:{userLoggedIn:["$rootScope","APIService",function(a,b){return b.getUserLoggedIn().success(function(b){a.userLoggedIn=b.nickname?b:null})}]}}).when("/profile",{controller:"ProfileController",templateUrl:"app/views/profile.html",resolve:{userLoggedIn:["$rootScope","APIService",function(a,b){return b.getUserLoggedIn().success(function(b){a.userLoggedIn=b.nickname?b:null})}]}}).when("/chat",{controller:"ChatController",templateUrl:"app/views/chat.html",resolve:{userLoggedIn:["$rootScope","APIService",function(a,b){return b.getUserLoggedIn().success(function(b){a.userLoggedIn=b.nickname?b:null})}]}}).when("/create_post",{controller:"MarkdownController",templateUrl:"app/views/createpost.html",resolve:{userLoggedIn:["$rootScope","APIService",function(a,b){return b.getUserLoggedIn().success(function(b){a.userLoggedIn=b.nickname?b:null})}]}}).when("/blog/main",{controller:"BlogController",templateUrl:"app/views/mainblogs.html",resolve:{userLoggedIn:["$rootScope","APIService",function(a,b){return b.getUserLoggedIn().success(function(b){a.userLoggedIn=b.nickname?b:null})}]}}).when("/blog/:UserId/:id",{controller:"BlogController",templateUrl:"app/views/blogpost.html",resolve:{userLoggedIn:["$rootScope","APIService",function(a,b){return b.getUserLoggedIn().success(function(b){a.userLoggedIn=b.nickname?b:null})}]}}).when("/about",{templateUrl:"app/views/about.html"}).otherwise({redirectTo:"/login"})}]),CBApp.run(["$rootScope","$location","APIService","$cookies",function(a,b,c,d){var e=d.get("profile");if("undefined"!=typeof e&&null!==e){var f=JSON.parse(e);a.profile=f}a.logOut=function(){c.logout().success(function(){FB.logout(function(){}),a.profile=void 0,a.userLoggedIn=void 0,d.remove("profile"),b.path("/login")})}}]),CBApp.controller("BlogController",["$scope","APIService","$routeParams","userLoggedIn","$location",function(a,b,c,d,e){a.newReply={},a.searchTerm=null,a.searchPosts=null,a.searchError=null,"undefined"!=typeof c.id?b.getPost({PostId:c.id,UserId:c.UserId}).success(function(b){a.post=b,a.countReplies=b.Replies.length,document.getElementById("content-container").innerHTML=b.content,a.postOwner=b.UserId===d.data.id}).error(function(a){console.log(a),e.path("/main")}):d.data.nickname?(b.getRecent().success(function(b){b.forEach(function(a){null===a.comImg&&(a.comImg="https://s-media-cache-ak0.pinimg.com/236x/d3/92/bd/d392bd3c66f992f3d8d35d66f1e51971.jpg")}),a.recentPosts=b}),b.getUsersPosts(d.data.id).success(function(b){b.forEach(function(a){null===a.comImg&&(a.comImg="https://s-media-cache-ak0.pinimg.com/236x/d3/92/bd/d392bd3c66f992f3d8d35d66f1e51971.jpg")}),a.usersPosts=b})):e.path("/login"),a.sendReply=function(){console.log(a.newReply),"undefined"!=typeof a.newReply.content&&null!==a.newReply.content&&a.newReply.content.length>1?(a.errorMessage=null,a.newReply.UserId=d.data.id,a.newReply.PostId=a.post.id,b.postReply(a.newReply).success(function(){location.reload()}).error(function(b){a.errorMessage=b.error})):a.errorMessage="Content of your reply was not worth posting and wasting storage"},a.deletePost=function(){a.deleteError=null,confirm("Are you sure?")&&a.post.UserId===d.data.id&&b.deletePost(a.post.id).success(function(){e.path("/main")}).error(function(b){a.deleteError=b.error})},a.searchPost=function(){b.searchPost(a.searchTerm).success(function(b){console.log(b),a.searchPosts=b}).error(function(b){a.searchError=b.error,a.searchPosts=null})}}]),CBApp.controller("ChatController",["$rootScope","$scope","Socket","APIService","$location","userLoggedIn",function(a,b,c,d,e,f){function g(a){for(var c=0,d=0;d<b.elementsPrinted.length;d++)b.elementsPrinted[d].id===a.id&&c++;if(0===c){b.elementsPrinted.push({id:a.id});var e="/"+a.fbId;FB.api(e,{fields:"picture.type(small)"},function(b){if(!b||b.error)console.log(b.error);else{var c=document.createElement("div"),d=document.createElement("div");c.className="participant-gray-lighter",d.className="row",c.id=a.id;var e=document.createElement("p");e.className="text-primary col-xs-8 col-sm-8 col-md-8 part-nick";var f=document.createElement("strong"),g=document.createTextNode(a.nickname);f.appendChild(g),e.appendChild(f);var h=document.createElement("img");h.src=b.picture.data.url,h.className="img-circle";var j=document.createElement("div");j.className="col-xs-4 col-sm-4 col-md-4",j.appendChild(h),d.appendChild(j),d.appendChild(e),c.appendChild(d),i(c)}})}}function h(a){for(var c=0,d=0;d<b.elementsPrinted.length;d++)b.elementsPrinted[d].id===a.id&&c++;if(0===c){b.elementsPrinted.push({id:a.id});var e=document.createElement("div"),f=document.createElement("div");e.className="participant-gray-lighter",f.className="row",e.id=a.id;var g=document.createElement("div");g.className="col-xs-4 col-sm-4 col-md-4",g.id="stuff-element";var h=document.createElement("p");h.className="text-primary col-xs-8 col-sm-8 col-md-8 part-nick";var j=document.createElement("strong"),k=document.createTextNode(a.nickname);j.appendChild(k),h.appendChild(j),f.appendChild(g),f.appendChild(h),e.appendChild(f),i(e)}}function i(a){var b=document.getElementById("users-fixed");b.appendChild(a)}f.data.nickname||e.path("/login"),b.currentUser=f.data,b.messages=[],b.room=null,b.inRoom=!1,b.users=[],b.elementsPrinted=[],d.getRooms().success(function(a){b.rooms=a}),c.on("send:message",function(a){b.messages.push(a);var c=document.getElementById("chat-messages");c.scrollTop=c.scrollHeight}),c.on("user:join",function(a){b.messages.push({nickname:"User "+a.nickname+" has joined."});for(var c=0,d=0;d<b.users.length;d++)b.users[d].id===a.id&&c++;0===c&&(b.users.push({nickname:a.nickname,id:a.id}),"not_set"!==a.fbId&&null!==a.fbId&&"not_set"!==b.currentUser.fbId&&null!==b.currentUser.fbId?g(a):h(a))}),c.on("user:left",function(a){b.messages.push({nickname:"User "+a.nickname+" has left room."});var c=document.getElementById("users-fixed"),d=document.getElementById(a.id);c.removeChild(d);var e=b.users.find(function(b){return b.id===a.id}),f=b.users.indexOf(e);f<0&&b.users.splice(f,1);var g=b.elementsPrinted.indexOf({id:a.id});g<0&&b.elementsPrinted.splice(f,1)}),c.on("get:users",function(a){a.nickname=b.currentUser.nickname,a.fbId=b.currentUser.fbId,a.id=b.currentUser.id,c.emit("get:user",a)}),c.on("add:user",function(a){for(var c=0,d=0;d<b.users.length;d++)b.users[d].id===a.id&&c++;0===c&&(b.users.push({nickname:a.nickname,id:a.id}),"not_set"!==a.fbId&&null!==a.fbId&&"not_set"!==b.currentUser.fbId&&null!==b.currentUser.fbId?g(a):h(a))}),c.on("refresh:rooms",function(){d.getRooms().success(function(a){b.rooms=a})}),b.sendMessage=function(){"undefined"!=typeof b.message&&b.message.length>0&&(c.emit("room:sent",{content:b.message,nickname:b.currentUser.nickname,UserId:b.currentUser.id,RoomId:b.room.id}),b.message="")},b.leaveRoom=function(){b.room&&(c.emit("room:leave",{nickname:b.currentUser.nickname,RoomId:b.room.id,id:b.currentUser.id}),b.room=null,b.inRoom=!1,b.users.splice(0,b.users.length),b.messages=[],b.errorMessage=null,a.profile.RoomId=null,b.elementsPrinted.length=0)},b.createRoom=function(){var e={name:b.roomName};if(null===b.room){for(var f=document.getElementById("users-fixed");f.firstChild;)f.removeChild(f.firstChild);b.elementsPrinted.length=0,d.addRoom(e).success(function(d){b.roomName="",c.emit("room:join",{RoomId:d.id,nickname:b.currentUser.nickname}),c.emit("new:room"),b.room=d,b.inRoom=!0,b.users.splice(0,b.users.length),b.errorMessage=null,a.profile.RoomId=d.id})}else b.errorMessage="You can not join new room until you have left from current one."},b.joinRoom=function(e){if(null===b.room){for(var f=document.getElementById("users-fixed");f.firstChild;)f.removeChild(f.firstChild);b.elementsPrinted.length=0,d.getRoom(e).success(function(d){b.room=d,b.inRoom=!0,b.users.splice(0,b.users.length),b.errorMessage=null,a.profile.RoomId=d.id,c.emit("room:join",{RoomId:d.id,nickname:b.currentUser.nickname,fbId:b.currentUser.fbId,id:b.currentUser.id})})}else b.errorMessage="You can not join this room until you have left from current one."};var j=b.$on("$locationChangeStart",function(a,c,d){b.leaveRoom(),b.users=void 0,b.elementsPrinted=void 0});b.$on("$destroy",function(){j()}),window.onbeforeunload=function(a){b.leaveRoom()}}]),CBApp.controller("MainController",["$scope","$location","userLoggedIn","APIService",function(a,b,c,d){c.data.nickname||b.path("/login"),d.getRecent().success(function(b){b.forEach(function(a){null===a.comImg&&(a.comImg="https://s-media-cache-ak0.pinimg.com/236x/d3/92/bd/d392bd3c66f992f3d8d35d66f1e51971.jpg")}),a.posts=b}),a.locateToChat=function(){b.path("/chat")}}]),CBApp.controller("MarkdownController",["$scope","userLoggedIn","$location","APIService",function(a,b,c,d){b.data.nickname||c.path("/login"),a.currentUser=b.data,a.sendObj={comImg:""},$("#markdown-trumb").trumbowyg({resetCss:!0,autogrow:!0,removeformatPasted:!0}),a.showResult=function(){var b=document.getElementById("preview-markdown");b.innerHTML=$("#markdown-trumb").trumbowyg("html"),a.currentDate=new Date,"none"===document.getElementById("preview-container").style.display&&(""===a.sendObj.comImg&&(a.sendObj.comImg="https://s-media-cache-ak0.pinimg.com/236x/d3/92/bd/d392bd3c66f992f3d8d35d66f1e51971.jpg"),$("#preview-container").show("slow"))},a.hideResult=function(){var b=document.getElementById("preview-container");"none"!==b.style.display&&("https://s-media-cache-ak0.pinimg.com/236x/d3/92/bd/d392bd3c66f992f3d8d35d66f1e51971.jpg"===a.sendObj.comImg&&(a.sendObj.comImg=""),$("#preview-container").hide("slow"))},a.sendPost=function(){var b=$("#markdown-trumb").trumbowyg("html");a.errorMessage=null,a.sendObj.content=b,a.sendObj.UserId=a.currentUser.id,""!==a.sendObj.comImg&&"https://s-media-cache-ak0.pinimg.com/236x/d3/92/bd/d392bd3c66f992f3d8d35d66f1e51971.jpg"!==a.sendObj.comImg||(a.sendObj.comImg=null),a.sendObj.title.length<100&&d.createPost(a.sendObj).success(function(){$("#markdown-trumb").trumbowyg("html",""),a.sendObj.title="",c.path("/main")}).error(function(b){console.log(b),a.errorMessage=b.error})}}]),CBApp.controller("ProfileController",["$rootScope","$scope","userLoggedIn","APIService","$location",function(a,b,c,d,e){c.data.nickname||e.path("/login"),b.currentUser=c.data,d.getUsersPosts(b.currentUser.id).success(function(a){a.forEach(function(a){null===a.comImg&&(a.comImg="https://s-media-cache-ak0.pinimg.com/236x/d3/92/bd/d392bd3c66f992f3d8d35d66f1e51971.jpg")}),b.usersPosts=a}),"not_set"!==b.currentUser.fbId&&FB.api("/me",{fields:"picture.width(9999).height(9999)"},function(a){if(!a||a.error)console.log(a.error);else{var b=document.getElementById("img-container");b&&(b.innerHTML='<img src="'+a.picture.data.url+'" class="img-responsive img-rounded">')}}),b.updatePassword=function(){b.currentUser.password=b.newPass,null!==b.currentUser.nickname&&""!==b.currentUser.nickname&&b.currentUser.nickname.length>2&&d.updatePassword(b.currentUser).success(function(c){b.errorMessage=null,b.confirmPassword="",b.newPass="",b.message="Update successful!",b.currentUser=c,a.profile=c,$cookies.putObject("profile",c)}).error(function(a){b.errorMessage=a.error,b.message=null})},b.hidePosts=function(){var a=document.getElementById("post-container");"none"===a.style.display?$("#post-container").show("slow"):$("#post-container").hide("slow")}}]),CBApp.controller("UserController",["$rootScope","$scope","APIService","$location","userLoggedIn","$cookies",function(a,b,c,d,e,f){e.data.nickname&&d.path("/main"),b.onFBlogin=function(){FB.login(function(b){b.authResponse&&FB.api("/me",{fields:["first_name","last_name","email"]},function(b){var e={firstName:b.first_name,lastName:b.last_name,nickname:b.first_name,fbId:b.id,email:b.email};c.loginFB(e).success(function(b){a.profile=b,a.profile.RoomId=null,f.putObject("profile",a.profile),d.path("/main")})})},{scope:"public_profile,email"})},b.register=function(){"undefined"!=typeof b.newUser&&(b.newUser.firstName.length<2||b.newUser.nickname.length<3||b.newUser.password.length<8?b.regError="User info not valid! Registration denied.":("undefined"!=typeof b.newUser.lastName&&""!==b.newUser.lastName&&null!==b.newUser.lastName||(b.newUser.lastName="not_set"),b.newUser.fbId="not_set",c.register(b.newUser).success(function(a){d.path("/login")}).error(function(a){b.regError=a.error,(b.newUser.lastName="not_set")&&(b.newUser.lastName="")})))},b.login=function(){"undefined"!=typeof b.user&&c.login(b.user).success(function(b){a.profile=b,a.profile.RoomId=null,f.putObject("profile",a.profile),d.path("/main")}).error(function(a){b.errorText=a.error})}}]),CBApp.service("APIService",["$http",function(a){this.addRoom=function(b){return a.post("/rooms",b)},this.getRoom=function(b){var c="/rooms/"+b;return a.get(c)},this.getRooms=function(){return a.get("/rooms")},this.register=function(b){return a.post("/users",b)},this.login=function(b){return a.post("/users/authenticate",b)},this.getUserLoggedIn=function(){return a.get("/users/current-auth")},this.logout=function(){return a.get("/users/logout")},this.updatePassword=function(b){return a.put("/users/update",b)},this.loginFB=function(b){return a.post("/users/fb_authenticate",b)},this.createPost=function(b){return a.post("/posts/create",b)},this.getUsersPosts=function(b){var c="/posts/user/"+b;return a.get(c)},this.getPost=function(b){var c="/posts/post/"+b.UserId+"/"+b.PostId;return a.get(c)},this.deletePost=function(b){var c="/posts/"+b;return a.delete(c)},this.getRecent=function(){return a.get("/posts/recent")},this.postReply=function(b){var c="/posts/"+b.PostId+"/reply";return a.post(c,b)},this.deletePost=function(b){var c="/posts/"+b;return a.delete(c)},this.searchPost=function(b){var c="/posts/search/"+b;return a.get(c)}}]),CBApp.factory("Socket",["$rootScope",function(a){var b=io.connect();return{on:function(c,d){b.on(c,function(){var c=arguments;a.$apply(function(){d.apply(b,c)})})},emit:function(c,d,e){b.emit(c,d,function(){var c=arguments;a.$apply(function(){e&&e.apply(b,c)})})}}}]);